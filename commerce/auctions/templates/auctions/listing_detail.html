{% extends "auctions/layout.html" %}
{% load static %}

{% block title %}{{listing.title}}{% endblock %}

{% block body %}
    <div class="container">
        <div class="listing-details" >
            <div class="listing-head" >
                <img src="{{listing.image_url}}" alt="listing image">
                {% if user.is_authenticated %}
                    <button id="watchlist-btn" data-listing="{{ listing.id }}" type="submit" class="btn btn-success">{% if listing in watchlist %}Remove from Watchlist{% else %} Add to Watchlist {% endif %}</button>
                {% endif %}
            </div>
            
            <h2>{{ listing.title }}</h2>
            <p><strong>Created by:</strong> {{ listing.user }}</p>
            <p><strong>Category:</strong> {% for category in listing.categories.all %}{{ category.name }} {% endfor %}</p>
            <p><strong>Description:</strong> {{ listing.description }}</p>
            <p><strong>Current Price:</strong> ${{ current_price.bid|default:listing.price.last.bid }}</p>
        </div>
        
        
        {% if user.is_authenticated %}

            <!-- Bidding Form -->
            <form method="post">
                {% csrf_token %}
                <input type="number" name="bid_amount" step="0.01" min="1" required>
                <button type="submit" name="bid">Place Bid</button>
            </form>

            <!-- Close Auction (Only for Owner) -->
            {% if is_owner and listing.active %}
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="close_auction">Close Auction</button>
                </form>
            {% endif %}

            <!-- Winner Announcement -->
            {% if not listing.active and user == current_price.user %}
                <p><strong>Congratulations! You won this auction.</strong></p>
            {% endif %}

            <!-- Comment Section -->
            <h3>Comments:</h3>
            {% for comment in comments %}
                <p><strong>{{ comment.user }}</strong>: {{ comment.comment }}</p>
            {% empty %}
                <p>No comments yet.</p>
            {% endfor %}

            <!-- Add Comment Form -->
            <form method="post">
                {% csrf_token %}
                <textarea name="comment" required></textarea>
                <button type="submit">Add Comment</button>
            </form>
        {% else %}
            <p><a href="{% url 'auctions:login' %}">Log in</a> to place bids, add to watchlist, or comment.</p>
        {% endif %}

    </div>
   
    <script>
        document.getElementById('watchlist-btn').addEventListener('click', function() {
            const listingId = this.dataset.listing;
        
            fetch('/change-watchlist/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 'listing_id': listingId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'added') {
                    this.innerText = 'Remove from Watchlist';
                } else {
                    this.innerText = 'Add to Watchlist';
                }
            });
        });
        </script>
    
{% endblock %}
